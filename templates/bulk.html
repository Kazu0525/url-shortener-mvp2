<!DOCTYPE html>
<html>
<head>
    <title>一括リンク生成システム</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 3px solid #4CAF50; padding-bottom: 10px; display: flex; align-items: center; }
        h1::before { content: '🚀'; margin-right: 10px; }
        .instructions { background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .instructions h3 { margin-bottom: 15px; display: flex; align-items: center; }
        .instructions h3::before { content: '📋'; margin-right: 8px; }
        .action-buttons { text-align: center; margin: 20px 0; }
        .btn { 
            padding: 8px 16px; margin: 3px; border: none; border-radius: 4px; 
            cursor: pointer; font-size: 13px; font-weight: 500;
            transition: all 0.2s ease;
        }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .btn-add { background: #2196F3; color: white; }
        .btn-clear { background: #FF9800; color: white; }
        .btn-generate { background: #f44336; color: white; font-weight: bold; }
        .btn-admin { background: #4CAF50; color: white; }
        .spreadsheet-container { margin: 20px 0; overflow-x: auto; border: 1px solid #ddd; border-radius: 8px; }
        .spreadsheet-table { width: 100%; border-collapse: collapse; min-width: 1400px; }
        .spreadsheet-table th { 
            background: #4CAF50; color: white; text-align: center; 
            padding: 12px 8px; border: 1px solid #45a049; font-weight: 600;
        }
        .spreadsheet-table td { border: 1px solid #ddd; padding: 4px; }
        .spreadsheet-table input { 
            width: 100%; border: none; padding: 8px 6px; font-size: 13px;
            outline: none; background: transparent;
        }
        .spreadsheet-table input:focus { background: #fff3cd; }
        .row-number { background: #f8f9fa; text-align: center; font-weight: bold; width: 60px; }
        .delete-btn { 
            background: #dc3545; color: white; border: none; 
            padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;
        }
        .results-section { margin: 30px 0; display: none; }
        .result-item { 
            background: #d4edda; padding: 15px; margin: 10px 0; 
            border-radius: 5px; border-left: 4px solid #28a745; 
        }
        .error-item { background: #f8d7da; border-left: 4px solid #dc3545; color: #721c24; }
        .copy-btn { 
            background: #fd7e14; color: white; border: none; 
            padding: 4px 8px; border-radius: 3px; cursor: pointer; margin-left: 8px; 
        }
        .loading { text-align: center; padding: 20px; }
        .spinner { 
            border: 3px solid #f3f3f3; border-top: 3px solid #4CAF50; 
            border-radius: 50%; width: 30px; height: 30px; 
            animation: spin 1s linear infinite; margin: 0 auto; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h1>一括リンク生成システム</h1>
        
        <div class="instructions">
            <h3>使い方</h3>
            <ol>
                <li><strong>B列（必須）</strong>: 短縮したい元のURLを入力（http:// または https:// で始めてください）</li>
                <li><strong>C列（任意）</strong>: カスタム短縮コードを入力（空白の場合は自動生成）</li>
                <li><strong>D列（任意）</strong>: カスタム名を入力（管理画面で識別しやすくします）</li>
                <li><strong>E列（任意）</strong>: キャンペーン名を入力（同じキャンペーンのURLをグループ化）</li>
                <li><strong>F列（任意）</strong>: 生成数量を入力（空白の場合は1個生成）</li>
                <li><strong>「🚀 一括生成開始」</strong>ボタンをクリック</li>
            </ol>
        </div>

        <div class="action-buttons">
            <button type="button" class="btn btn-add" onclick="addRows(1)">➕ 1行追加</button>
            <button type="button" class="btn btn-add" onclick="addRows(5)">➕ 5行追加</button>
            <button type="button" class="btn btn-add" onclick="addRows(10)">➕ 10行追加</button>
            <button type="button" class="btn btn-clear" onclick="clearAllData()">🗑️ 全削除</button>
            <button type="button" class="btn btn-generate" onclick="startGeneration()">🚀 一括生成開始</button>
            <button type="button" class="btn btn-admin" onclick="location.href='/admin'">📊 管理画面へ</button>
        </div>

        <div class="spreadsheet-container">
            <table class="spreadsheet-table">
                <thead>
                    <tr>
                        <th style="width: 50px;">A<br>行番号</th>
                        <th style="width: 35%;">B<br>オリジナルURL ※必須</th>
                        <th style="width: 12%;">C<br>カスタム短縮コード<br>(任意)</th>
                        <th style="width: 12%;">D<br>カスタム名<br>(任意)</th>
                        <th style="width: 12%;">E<br>キャンペーン名<br>(任意)</th>
                        <th style="width: 8%;">F<br>生成数量<br>(任意)</th>
                        <th style="width: 11%;">操作</th>
                    </tr>
                </thead>
                <tbody id="dataTable">
                    <tr>
                        <td class="row-number">1</td>
                        <td><input type="url" placeholder="https://example.com" /></td>
                        <td><input type="text" placeholder="例: product01" /></td>
                        <td><input type="text" placeholder="例: 商品A" /></td>
                        <td><input type="text" placeholder="例: 春キャンペーン" /></td>
                        <td><input type="number" min="1" max="20" value="1" /></td>
                        <td><button class="delete-btn" onclick="deleteRow(this)">🗑️ 削除</button></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="action-buttons">
            <button type="button" class="btn btn-add" onclick="addRows(1)">➕ 1行追加</button>
            <button type="button" class="btn btn-add" onclick="addRows(5)">➕ 5行追加</button>
            <button type="button" class="btn btn-add" onclick="addRows(10)">➕ 10行追加</button>
            <button type="button" class="btn btn-clear" onclick="clearAllData()">🗑️ 全削除</button>
            <button type="button" class="btn btn-generate" onclick="startGeneration()">🚀 一括生成開始</button>
        </div>

        <div class="results-section" id="resultsArea">
            <h2>📈 生成結果</h2>
            <div id="resultsContent"></div>
        </div>
    </div>

    <script>
        let rowCount = 1;
        
        // 行追加機能
        function addRows(count) {
            const table = document.getElementById('dataTable');
            
            for (let i = 0; i < count; i++) {
                rowCount++;
                const newRow = table.insertRow();
                newRow.innerHTML = `
                    <td class="row-number">${rowCount}</td>
                    <td><input type="url" placeholder="https://example.com" /></td>
                    <td><input type="text" placeholder="例: product${rowCount.toString().padStart(2, '0')}" /></td>
                    <td><input type="text" placeholder="例: 商品${String.fromCharCode(65 + (rowCount % 26))}" /></td>
                    <td><input type="text" placeholder="例: 春キャンペーン" /></td>
                    <td><input type="number" min="1" max="20" value="1" /></td>
                    <td><button class="delete-btn" onclick="deleteRow(this)">🗑️ 削除</button></td>
                `;
            }
            updateRowNumbers();
        }
        
        // 行削除機能
        function deleteRow(button) {
            const table = document.getElementById('dataTable');
            if (table.rows.length > 1) {
                button.closest('tr').remove();
                updateRowNumbers();
            } else {
                alert('最低1行は必要です');
            }
        }
        
        // 行番号更新
        function updateRowNumbers() {
            const table = document.getElementById('dataTable');
            for (let i = 0; i < table.rows.length; i++) {
                table.rows[i].cells[0].textContent = i + 1;
            }
            rowCount = table.rows.length;
        }
        
        // 全削除機能
        function clearAllData() {
            if (confirm('全てのデータを削除しますか？')) {
                const table = document.getElementById('dataTable');
                table.innerHTML = `
                    <tr>
                        <td class="row-number">1</td>
                        <td><input type="url" placeholder="https://example.com" /></td>
                        <td><input type="text" placeholder="例: product01" /></td>
                        <td><input type="text" placeholder="例: 商品A" /></td>
                        <td><input type="text" placeholder="例: 春キャンペーン" /></td>
                        <td><input type="number" min="1" max="20" value="1" /></td>
                        <td><button class="delete-btn" onclick="deleteRow(this)">🗑️ 削除</button></td>
                    </tr>
                `;
                rowCount = 1;
                document.getElementById('resultsArea').style.display = 'none';
            }
        }
        
        // 一括生成機能
        async function startGeneration() {
            const table = document.getElementById('dataTable');
            const urlList = [];
            
            // データ収集
            for (let i = 0; i < table.rows.length; i++) {
                const row = table.rows[i];
                const url = row.cells[1].querySelector('input').value.trim();
                
                if (url) {
                    if (!url.startsWith('http://') && !url.startsWith('https://')) {
                        alert(`行 ${i + 1}: URLは http:// または https:// で始めてください`);
                        return;
                    }
                    urlList.push(url);
                }
            }
            
            if (urlList.length === 0) {
                alert('少なくとも1つのURLを入力してください');
                return;
            }
            
            // 生成処理
            const generateBtns = document.querySelectorAll('.btn-generate');
            generateBtns.forEach(btn => {
                btn.disabled = true;
                btn.textContent = '⏳ 生成中...';
            });
            
            const resultsArea = document.getElementById('resultsArea');
            const resultsContent = document.getElementById('resultsContent');
            resultsArea.style.display = 'block';
            resultsContent.innerHTML = '<div class="loading"><div class="spinner"></div><p>リンクを生成しています...</p></div>';
            
            try {
                const formData = new FormData();
                formData.append('urls', urlList.join('\n'));
                
                const response = await fetch('/api/bulk-process', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`処理エラー: ${response.status}`);
                }
                
                const result = await response.json();
                showResults(result);
                
            } catch (error) {
                resultsContent.innerHTML = `<div class="error-item">エラーが発生しました: ${error.message}</div>`;
            } finally {
                generateBtns.forEach(btn => {
                    btn.disabled = false;
                    btn.textContent = '🚀 一括生成開始';
                });
            }
        }
        
        // 結果表示
        function showResults(result) {
            const resultsContent = document.getElementById('resultsContent');
            let successCount = 0;
            let errorCount = 0;
            
            if (result.results) {
                result.results.forEach(item => {
                    if (item.success) successCount++;
                    else errorCount++;
                });
            }
            
            let html = `
                <div style="background: #e7f3ff; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <h3>📊 生成結果サマリー</h3>
                    <p>成功: <strong>${successCount}</strong> | エラー: <strong>${errorCount}</strong> | 合計: <strong>${successCount + errorCount}</strong></p>
                </div>
            `;
            
            if (result.results) {
                result.results.forEach((item, index) => {
                    if (item.success) {
                        html += `
                            <div class="result-item">
                                <p><strong>${index + 1}. 元URL:</strong> ${item.url}</p>
                                <p><strong>短縮URL:</strong> 
                                    <a href="${item.short_url}" target="_blank">${item.short_url}</a>
                                    <button class="copy-btn" onclick="copyText('${item.short_url}')">📋 コピー</button>
                                </p>
                            </div>
                        `;
                    } else {
                        html += `<div class="error-item">❌ ${item.url} - ${item.error}</div>`;
                    }
                });
            }
            
            resultsContent.innerHTML = html;
        }
        
        // コピー機能
        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert(`クリップボードにコピーしました: ${text}`);
            }).catch(() => {
                prompt('以下のURLをコピーしてください:', text);
            });
        }
        
        // 初期化
        window.addEventListener('load', function() {
            console.log('一括生成システム準備完了');
            // 初期表示で4行追加
            addRows(4);
        });
    </script>
</body>
</html>
